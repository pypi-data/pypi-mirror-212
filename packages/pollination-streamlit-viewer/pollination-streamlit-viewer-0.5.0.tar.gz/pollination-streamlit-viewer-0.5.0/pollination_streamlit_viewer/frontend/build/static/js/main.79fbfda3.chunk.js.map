{"version":3,"sources":["VTKStreamlit.tsx","index.tsx"],"names":["VTKStreamlit","renderData","useStreamlit","viewerRef","useRef","React","useState","viewerState","setViewerState","viewerSceneRef","actionStackRef","undefined","file","setFile","handleScreenshot","useCallback","fileName","current","useEffect","args","Streamlit","setComponentValue","scene","length","map","id","ref","isequal","dispatchActionStack","dispatch","findIndex","a","type","screenshotName","console","log","actions","reverse","filter","action","i","array","ids","debouncedDispatch","debounce","leading","maxWait","currFile","loadFile","config","Blob","height","includes","setFrameHeight","parseInt","replace","cssStyle","useMemo","border","borderRadius","toolbar","sider","style","width","display","flexDirection","Content","ReactDOM","render","StrictMode","document","getElementById"],"mappings":"6VAwKeA,EAxJ+B,WAAO,IAAD,IAE5CC,EAAaC,yBAEbC,EAAYC,iBAAY,MAG9B,EAAsCC,IAAMC,SAAc,IAA1D,mBAAOC,EAAP,KAAoBC,EAApB,KACMC,EAAiBL,iBAAc,IAG/BM,EAAiBN,iBAAc,IAGrC,EAAwBC,IAAMC,cAAiCK,GAA/D,mBAAOC,EAAP,KAAaC,EAAb,KAEMC,EAAmBC,uBAAY,WAAgC,IAA/BC,EAA8B,uDAArB,iBACxCb,EAAUc,SACfd,EAAUc,QAAQH,iBAAiBE,GAAU,KAC5C,IAEHE,qBAAU,WACR,GAAIjB,GAAcA,EAAWkB,KAAX,UAChBC,YAAUC,kBAAkBd,QACvB,GAAIA,EAAYe,OAASf,EAAYe,MAAMC,OAAS,EAAG,CAC5D,IAAMD,EAAQf,EAAYe,MAAME,KAAI,qBAAEC,MAChCC,EAAMjB,EAAeQ,QAAQO,KAAI,qBAAEC,MAEzC,GAAIE,IAAQL,EAAOI,GAAM,OAEzBjB,EAAeQ,QAAf,YAA6BV,EAAYe,OAEzCF,YAAUC,kBAAkB,CAC1BC,MAAOb,EAAeQ,aAGzB,CAACV,EAAaN,IAGjB,IAAM2B,EAAsBb,uBAAY,WACtC,GAAIZ,EAAUc,SAAWd,EAAUc,QAAQY,UACzCnB,EAAeO,SAAWP,EAAeO,QAAQM,OAAS,EAAG,CAI7D,IAAyB,IADDb,EAAeO,QAAQa,WAAU,SAAAC,GAAC,MAAe,yBAAXA,EAAEC,QACpC,CAC1B,IAAMC,GAA2B,OAAVhC,QAAU,IAAVA,OAAA,EAAAA,EAAYkB,OAAQlB,EAAWkB,KAAX,gBAAqClB,EAAWkB,KAAX,qBAAqCR,EAChHsB,GACHC,QAAQC,IAAR,OAAYlC,QAAZ,IAAYA,OAAZ,EAAYA,EAAYkB,MAE1BL,EAAiBmB,GAKnB,IAAMG,EAAU,YAAI1B,EAAeO,SAASoB,UACzCC,QAAO,SAACC,EAAQC,EAAGC,GAAZ,MACW,yBAAhBF,EAAOP,MACgB,qBAAfO,EAAOG,KAChBD,EAAMX,WAAU,SAAAC,GAAC,OAAIA,EAAEC,OAASO,EAAOP,UAAUQ,KAGrDrC,EAAUc,QAAQY,SAASO,GAC3B1B,EAAeO,QAAU,MAE1B,CAACH,EAAkBb,IAEhB0C,EAAoB5B,sBAAY6B,IAAShB,EAAqB,IAAK,CAAEiB,SAAQ,EAAMC,QAAS,MAAQ,CAAClB,IAE3GV,qBAAU,WACJjB,QAAyDU,WAApCV,EAAWkB,KAAX,cACpBhB,EAAUc,SAAWd,EAAUc,QAAQY,WAC1CnB,EAAeO,QAAf,sBACKP,EAAeO,SADpB,YAEKhB,EAAWkB,KAAX,eAEDT,EAAeO,QAAQM,OAAS,GAClCoB,OAGH,CAAC1C,EAAY0C,IAEhBzB,qBAAU,WACJjB,GAAcA,EAAWkB,KAAX,SAChBN,GAAQ,SAAAkC,GACN,OAAKA,GACSpB,IAAQ1B,EAAWkB,KAAX,QAA4B4B,GACnCA,EAFO9C,EAAWkB,KAAX,aAKzB,CAAClB,IAgBJiB,qBAAU,WACHN,GAfU,SAACA,GAChB,GAAIT,EAAUc,SAAWd,EAAUc,QAAQY,UAAY1B,EAAUc,QAAQ+B,SAAU,CAE9E/C,GAAcA,EAAWkB,KAAX,OAA0BhB,EAAUc,QAAQY,SAAS,CAAEG,KAAM,eAAgB,GAE9F,IAAMV,EAAQb,EAAeQ,QAC7B,IAAKK,EAAO,OAEZ,IAAM2B,EAAS3B,EAAMC,OAAS,EAAID,OAAQX,EAE1CR,EAAUc,QAAQ+B,SAAS,IAAIE,KAAK,CAACtC,IAAQ,QAASqC,IAMxDD,CAASpC,KAER,CAACA,IAEJM,qBAAU,WACHjB,IAEmC,qBAA7BA,EAAWkB,KAAX,OACPlB,EAAWkB,KAAX,MAAyBgC,QACzBlD,EAAWkB,KAAX,MAAyBgC,OAAOC,SAAS,MACvChC,YAAUiC,eAAeC,SAASrD,EAAWkB,KAAX,MAAyBgC,OAAOI,QAAQ,KAAM,MAEpFnC,YAAUiC,eA1HD,QA4HV,CAACpD,IAEJ,IAAMuD,EAAWC,mBAAQ,WACvB,OAAOxD,GAAkD,qBAA7BA,EAAWkB,KAAX,MAC1BlB,EAAWkB,KAAX,MACA,CAAEuC,OAAQ,oBAAqBC,aAAc,MAAOR,OAAO,GAAD,OAjIjD,IAiIiD,SAC3D,CAAClD,IAEE2D,GAAU3D,GAAoD,qBAA/BA,EAAWkB,KAAX,SAA6ClB,EAAWkB,KAAX,QAC5E0C,GAAQ5D,GAAkD,qBAA7BA,EAAWkB,KAAX,OAA2ClB,EAAWkB,KAAX,MAE9E,OACE,yBAAK2C,MAAK,yBAAIC,MAAO,OAAQZ,OAAO,GAAD,OAxIxB,IAwIwB,MAAiBO,OAAQ,oBAAqBC,aAAc,OAAUH,GAA/F,IAAyGQ,QAAS,UAC1H,kBAAC,IAAD,CAAQF,MAAO,CAAEG,cAAe,QAC7BJ,GACC,kBAAC,IAAD,CAAiBhC,SAAQ,UAAE1B,EAAUc,eAAZ,aAAE,EAAmBY,SAAUtB,YAAaA,EAAaO,iBAAkBA,IAEtG,kBAAC,IAAD,KACG8C,GACC,kBAAC,IAAD,CAAoB/B,SAAQ,UAAE1B,EAAUc,eAAZ,aAAE,EAAmBY,SAAUtB,YAAaA,EAAaO,iBAAkBA,IAEzG,kBAAC,IAAOoD,QAAR,CAAgBJ,MAAO,CAAEE,QAAS,OAAQC,cAAe,WACvD,kBAAC,IAAD,CAAWzD,eAAgBA,EAAgBkB,IAAKvB,S,OCzJ5DgE,IAASC,OACP,kBAAC,IAAMC,WAAP,KACE,kBAAC,gBAAD,KACE,kBAAC,EAAD,QAGJC,SAASC,eAAe,W","file":"static/js/main.79fbfda3.chunk.js","sourcesContent":["import React, { useCallback, useEffect, useMemo, useRef } from \"react\"\n\nimport { Streamlit } from \"streamlit-component-lib\"\nimport { useStreamlit } from \"streamlit-component-lib-react-hooks\"\n\nimport { VTKViewer, VTKViewerDrawer, VTKFloatingToolbar } from \"pollination-viewer\"\n\nimport { Layout } from \"antd\"\n\nimport './VTKStreamlit.css'\n\nimport isequal from \"lodash.isequal\"\nimport debounce from \"lodash.debounce\"\n\nconst HEIGHT = 640\n\nconst VTKStreamlit: React.FunctionComponent = () => {\n\n  const renderData = useStreamlit()\n\n  const viewerRef = useRef<any>(null)\n\n  // state returned to streamlit\n  const [viewerState, setViewerState] = React.useState<any>({})\n  const viewerSceneRef = useRef<any[]>([])\n\n  // stack of actions to dispatch via vtkjs\n  const actionStackRef = useRef<any[]>([])\n\n  // file to be loaded\n  const [file, setFile] = React.useState<Uint8Array | undefined>(undefined)\n\n  const handleScreenshot = useCallback((fileName='VTKJSStreamlit') => {\n    if (!viewerRef.current) return\n    viewerRef.current.handleScreenshot(fileName, false)\n  }, [])\n\n  useEffect(() => {\n    if (renderData && renderData.args[\"subscribe\"]) {\n      Streamlit.setComponentValue(viewerState)\n    } else if (viewerState.scene && viewerState.scene.length > 0) {\n      const scene = viewerState.scene.map(({id}: {id: string}) => id)\n      const ref = viewerSceneRef.current.map(({id}: {id: string}) => id)\n\n      if (isequal(scene, ref)) return\n      \n      viewerSceneRef.current = [...viewerState.scene]\n\n      Streamlit.setComponentValue({\n        scene: viewerSceneRef.current\n      })\n    }\n  }, [viewerState, renderData])\n\n  // aggreate and dispatch actions on a debounced interval\n  const dispatchActionStack = useCallback(() => {\n    if (viewerRef.current && viewerRef.current.dispatch &&\n      actionStackRef.current && actionStackRef.current.length > 0) {\n\n      // handles screenshot as a special case\n      const screenshotIndex = actionStackRef.current.findIndex(a => a.type === \"streamlit-screenshot\")\n      if (screenshotIndex !== -1) {\n        const screenshotName = renderData?.args && renderData.args['screenshot_name'] ? renderData.args['screenshot_name'] : undefined\n        if (!screenshotName) {\n          console.log(renderData?.args)\n        }\n        handleScreenshot(screenshotName)\n      }\n\n      // filters type === \"strealit-screenshot\", and actions with duplicate types\n      // any action with ids [] will be dispatched\n      const actions = [...actionStackRef.current].reverse()\n        .filter((action, i, array) =>\n          (action.type !== \"streamlit-screenshot\" &&\n            typeof action.ids !== 'undefined') ||\n          array.findIndex(a => a.type === action.type) === i\n        )\n\n      viewerRef.current.dispatch(actions)\n      actionStackRef.current = []\n    }\n  }, [handleScreenshot, renderData])\n\n  const debouncedDispatch = useCallback(debounce(dispatchActionStack, 250, { leading:true, maxWait: 750 }), [dispatchActionStack])\n\n  useEffect(() => {\n    if (renderData && typeof renderData.args[\"action_stack\"] !== undefined\n      && viewerRef.current && viewerRef.current.dispatch) {\n      actionStackRef.current = [\n        ...actionStackRef.current,\n        ...renderData.args[\"action_stack\"]\n      ]\n      if (actionStackRef.current.length > 0) {\n        debouncedDispatch()\n      }\n    }\n  }, [renderData, debouncedDispatch])\n\n  useEffect(() => {\n    if (renderData && renderData.args[\"content\"]) {\n      setFile(currFile => {\n        if (!currFile) return renderData.args[\"content\"]\n        const equal = isequal(renderData.args[\"content\"], currFile)\n        return equal ? currFile : renderData.args[\"content\"]\n      })\n    }\n  }, [renderData])\n  \n  const loadFile = (file: Uint8Array) => {\n    if (viewerRef.current && viewerRef.current.dispatch && viewerRef.current.loadFile) {\n\n      if(renderData && renderData.args[\"clear\"]) viewerRef.current.dispatch({ type: 'remove-all' }, true)\n\n      const scene = viewerSceneRef.current\n      if (!scene) return\n\n      const config = scene.length > 0 ? scene : undefined\n\n      viewerRef.current.loadFile(new Blob([file]), 'vtkjs', config)\n    }\n  }\n\n  useEffect(() => {\n    if (!file) return\n    loadFile(file)\n    // eslint-disable-next-line\n  }, [file])\n\n  useEffect(() => {\n    if (!renderData) return\n    \n    if (typeof renderData.args[\"style\"] !== 'undefined' && \n        renderData.args[\"style\"].height && \n        renderData.args[\"style\"].height.includes('px')) {\n          Streamlit.setFrameHeight(parseInt(renderData.args[\"style\"].height.replace('px', '')))\n    } else {\n      Streamlit.setFrameHeight(HEIGHT)\n    }\n  }, [renderData])\n\n  const cssStyle = useMemo(() => {\n    return renderData && typeof renderData.args[\"style\"] !== 'undefined' ? \n      renderData.args[\"style\"] : \n      { border: \"1px solid #d0d7de\", borderRadius: \"2px\", height: `${HEIGHT}px` }\n  }, [renderData])\n\n  const toolbar = renderData && typeof renderData.args[\"toolbar\"] !== 'undefined' ? renderData.args[\"toolbar\"] : true\n  const sider = renderData && typeof renderData.args[\"sider\"] !== 'undefined' ? renderData.args[\"sider\"] : true\n\n  return (\n    <div style={{ width: '100%', height: `${HEIGHT}px`, border: \"1px solid #d0d7de\", borderRadius: \"2px\", ...cssStyle, display: 'flex' }}>\n      <Layout style={{ flexDirection: 'row' }}>\n        {sider &&\n          <VTKViewerDrawer dispatch={viewerRef.current?.dispatch} viewerState={viewerState} handleScreenshot={handleScreenshot} />\n        }\n        <Layout>\n          {toolbar &&\n            <VTKFloatingToolbar dispatch={viewerRef.current?.dispatch} viewerState={viewerState} handleScreenshot={handleScreenshot} />\n          }\n          <Layout.Content style={{ display: 'flex', flexDirection: 'column' }}>\n            <VTKViewer setViewerState={setViewerState} ref={viewerRef} />\n          </Layout.Content>\n        </Layout>\n      </Layout>\n    </div>\n  )\n}\n\nexport default VTKStreamlit","import React from \"react\"\nimport ReactDOM from \"react-dom\"\nimport { ErrorBoundary } from \"streamlit-component-lib-react-hooks\"\nimport VTKStreamlit from \"./VTKStreamlit\"\n\nimport 'antd/dist/antd.css';\n\nReactDOM.render(\n  <React.StrictMode>\n    <ErrorBoundary>\n      <VTKStreamlit />\n    </ErrorBoundary>\n  </React.StrictMode>,\n  document.getElementById(\"root\")\n)\n"],"sourceRoot":""}