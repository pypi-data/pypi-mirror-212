"use strict";(self.webpackChunk_jupytercad_jupytercad_extension=self.webpackChunk_jupytercad_jupytercad_extension||[]).push([[711],{44711:(e,t,s)=>{s.r(t),s.d(t,{ICollaborativeDrive:()=>W,WebSocketProvider:()=>R,YDrive:()=>H});var n=s(9324),o=s(59474),i=s(3020),a=s(97930),c=s(74901),r=(s(90981),s(23205));const h=()=>new Set;var d=s(97225),l=s(55852);const u=new Map,p="undefined"==typeof BroadcastChannel?class{constructor(e){this.room=e,this.onmessage=null,this._onChange=t=>t.key===e&&null!==this.onmessage&&this.onmessage({data:d.Gh(t.newValue||"")}),l.z2(this._onChange)}postMessage(e){l.XN.setItem(this.room,d.s3(d.eh(e)))}close(){l.F(this._onChange)}}:BroadcastChannel,_=e=>r.Yu(u,e,(()=>{const t=h(),s=new p(e);return s.onmessage=e=>t.forEach((t=>t(e.data,"broadcastchannel"))),{bc:s,subs:t}})),f=(e,t,s=null)=>{const n=_(e);n.bc.postMessage(t),n.subs.forEach((e=>e(t,s)))},m=Date.now;var w=s(69476),y=s(82256),g=s(68078),v=s(21332);const b=Array.from;Array.isArray;class k{constructor(){this._observers=r.Ue()}on(e,t){r.Yu(this._observers,e,h).add(t)}once(e,t){const s=(...n)=>{this.off(e,s),t(...n)};this.on(e,s)}off(e,t){const s=this._observers.get(e);void 0!==s&&(s.delete(t),0===s.size&&this._observers.delete(e))}emit(e,t){return b((this._observers.get(e)||r.Ue()).values()).forEach((e=>e(...t)))}destroy(){this._observers=r.Ue()}}var C=s(1872);class I extends k{constructor(e){super(),this.doc=e,this.clientID=e.clientID,this.states=new Map,this.meta=new Map,this._checkInterval=setInterval((()=>{const e=m();null!==this.getLocalState()&&15e3<=e-this.meta.get(this.clientID).lastUpdated&&this.setLocalState(this.getLocalState());const t=[];this.meta.forEach(((s,n)=>{n!==this.clientID&&3e4<=e-s.lastUpdated&&this.states.has(n)&&t.push(n)})),t.length>0&&S(this,t,"timeout")}),v.GW(3e3)),e.on("destroy",(()=>{this.destroy()})),this.setLocalState({})}destroy(){this.emit("destroy",[this]),this.setLocalState(null),super.destroy(),clearInterval(this._checkInterval)}getLocalState(){return this.states.get(this.clientID)||null}setLocalState(e){const t=this.clientID,s=this.meta.get(t),n=void 0===s?0:s.clock+1,o=this.states.get(t);null===e?this.states.delete(t):this.states.set(t,e),this.meta.set(t,{clock:n,lastUpdated:m()});const i=[],a=[],c=[],r=[];null===e?r.push(t):null==o?null!=e&&i.push(t):(a.push(t),C.Hi(o,e)||c.push(t)),(i.length>0||c.length>0||r.length>0)&&this.emit("change",[{added:i,updated:c,removed:r},"local"]),this.emit("update",[{added:i,updated:a,removed:r},"local"])}setLocalStateField(e,t){const s=this.getLocalState();null!==s&&this.setLocalState({...s,[e]:t})}getStates(){return this.states}}const S=(e,t,s)=>{const n=[];for(let s=0;s<t.length;s++){const o=t[s];if(e.states.has(o)){if(e.states.delete(o),o===e.clientID){const t=e.meta.get(o);e.meta.set(o,{clock:t.clock+1,lastUpdated:m()})}n.push(o)}}n.length>0&&(e.emit("change",[{added:[],updated:[],removed:n},s]),e.emit("update",[{added:[],updated:[],removed:n},s]))},U=(e,t,s=e.states)=>{const n=t.length,o=w.Mf();w.uE(o,n);for(let i=0;i<n;i++){const n=t[i],a=s.get(n)||null,c=e.meta.get(n).clock;w.uE(o,n),w.uE(o,c),w.uw(o,JSON.stringify(a))}return w._f(o)};var D=s(69600),E=s(34406);const M=[];M[0]=(e,t,s,n,o)=>{w.uE(e,0);const i=g.zu(t,e,s.doc,s);n&&i===g.Px&&!s.synced&&(s.synced=!0)},M[3]=(e,t,s,n,o)=>{w.uE(e,1),w.mP(e,U(s.awareness,Array.from(s.awareness.getStates().keys())))},M[1]=(e,t,s,n,o)=>{((e,t,s)=>{const n=y.l1(t),o=m(),i=[],a=[],c=[],r=[],h=y.yg(n);for(let t=0;t<h;t++){const t=y.yg(n);let s=y.yg(n);const h=JSON.parse(y.kf(n)),d=e.meta.get(t),l=e.states.get(t),u=void 0===d?0:d.clock;(u<s||u===s&&null===h&&e.states.has(t))&&(null===h?t===e.clientID&&null!=e.getLocalState()?s++:e.states.delete(t):e.states.set(t,h),e.meta.set(t,{clock:s,lastUpdated:o}),void 0===d&&null!==h?i.push(t):void 0!==d&&null===h?r.push(t):null!==h&&(C.Hi(h,l)||c.push(t),a.push(t)))}(i.length>0||c.length>0||r.length>0)&&e.emit("change",[{added:i,updated:c,removed:r},s]),(i.length>0||a.length>0||r.length>0)&&e.emit("update",[{added:i,updated:a,removed:r},s])})(s.awareness,y.HN(t),s)},M[2]=(e,t,s,n,o)=>{((e,t,s)=>{0===y.yg(e)&&s(0,y.kf(e))})(t,s.doc,((e,t)=>L(s,t)))};const L=(e,t)=>console.warn(`Permission denied to access ${e.url}.\n${t}`),$=(e,t,s)=>{const n=y.l1(t),o=w.Mf(),i=y.yg(n),a=e.messageHandlers[i];return a?a(o,n,e,s,i):console.error("Unable to compute message"),o},P=e=>{if(e.shouldConnect&&null===e.ws){const t=new e._WS(e.url);t.binaryType="arraybuffer",e.ws=t,e.wsconnecting=!0,e.wsconnected=!1,e.synced=!1,t.onmessage=s=>{e.wsLastMessageReceived=m();const n=$(e,new Uint8Array(s.data),!0);w.kE(n)>1&&t.send(w._f(n))},t.onerror=t=>{e.emit("connection-error",[t,e])},t.onclose=t=>{e.emit("connection-close",[t,e]),e.ws=null,e.wsconnecting=!1,e.wsconnected?(e.wsconnected=!1,e.synced=!1,S(e.awareness,Array.from(e.awareness.getStates().keys()).filter((t=>t!==e.doc.clientID)),e),e.emit("status",[{status:"disconnected"}])):e.wsUnsuccessfulReconnects++,setTimeout(P,v.VV(100*v.sQ(2,e.wsUnsuccessfulReconnects),e.maxBackoffTime),e)},t.onopen=()=>{e.wsLastMessageReceived=m(),e.wsconnecting=!1,e.wsconnected=!0,e.wsUnsuccessfulReconnects=0,e.emit("status",[{status:"connected"}]);const s=w.Mf();if(w.uE(s,0),g._J(s,e.doc),t.send(w._f(s)),null!==e.awareness.getLocalState()){const s=w.Mf();w.uE(s,1),w.mP(s,U(e.awareness,[e.doc.clientID])),t.send(w._f(s))}},e.emit("status",[{status:"connecting"}])}},T=(e,t)=>{const s=e.ws;e.wsconnected&&s&&s.readyState===s.OPEN&&s.send(t),e.bcconnected&&f(e.bcChannel,t,e)};class x extends k{constructor(e,t,s,{connect:n=!0,awareness:o=new I(s),params:i={},WebSocketPolyfill:a=WebSocket,resyncInterval:c=-1,maxBackoffTime:r=2500,disableBc:h=!1}={}){for(super();"/"===e[e.length-1];)e=e.slice(0,e.length-1);const d=(e=>D.UI(e,((e,t)=>`${encodeURIComponent(t)}=${encodeURIComponent(e)}`)).join("&"))(i);this.maxBackoffTime=r,this.bcChannel=e+"/"+t,this.url=e+"/"+t+(0===d.length?"":"?"+d),this.roomname=t,this.doc=s,this._WS=a,this.awareness=o,this.wsconnected=!1,this.wsconnecting=!1,this.bcconnected=!1,this.disableBc=h,this.wsUnsuccessfulReconnects=0,this.messageHandlers=M.slice(),this._synced=!1,this.ws=null,this.wsLastMessageReceived=0,this.shouldConnect=n,this._resyncInterval=0,c>0&&(this._resyncInterval=setInterval((()=>{if(this.ws&&this.ws.readyState===WebSocket.OPEN){const e=w.Mf();w.uE(e,0),g._J(e,s),this.ws.send(w._f(e))}}),c)),this._bcSubscriber=(e,t)=>{if(t!==this){const t=$(this,new Uint8Array(e),!1);w.kE(t)>1&&f(this.bcChannel,w._f(t),this)}},this._updateHandler=(e,t)=>{if(t!==this){const t=w.Mf();w.uE(t,0),g.lr(t,e),T(this,w._f(t))}},this.doc.on("update",this._updateHandler),this._awarenessUpdateHandler=({added:e,updated:t,removed:s},n)=>{const i=e.concat(t).concat(s),a=w.Mf();w.uE(a,1),w.mP(a,U(o,i)),T(this,w._f(a))},this._unloadHandler=()=>{S(this.awareness,[s.clientID],"window unload")},"undefined"!=typeof window?window.addEventListener("unload",this._unloadHandler):void 0!==E&&E.on("exit",this._unloadHandler),o.on("update",this._awarenessUpdateHandler),this._checkInterval=setInterval((()=>{this.wsconnected&&3e4<m()-this.wsLastMessageReceived&&this.ws.close()}),3e3),n&&this.connect()}get synced(){return this._synced}set synced(e){this._synced!==e&&(this._synced=e,this.emit("synced",[e]),this.emit("sync",[e]))}destroy(){0!==this._resyncInterval&&clearInterval(this._resyncInterval),clearInterval(this._checkInterval),this.disconnect(),"undefined"!=typeof window?window.removeEventListener("unload",this._unloadHandler):void 0!==E&&E.off("exit",this._unloadHandler),this.awareness.off("update",this._awarenessUpdateHandler),this.doc.off("update",this._updateHandler),super.destroy()}connectBc(){if(this.disableBc)return;var e,t;this.bcconnected||(e=this.bcChannel,t=this._bcSubscriber,_(e).subs.add(t),this.bcconnected=!0);const s=w.Mf();w.uE(s,0),g._J(s,this.doc),f(this.bcChannel,w._f(s),this);const n=w.Mf();w.uE(n,0),g.K0(n,this.doc),f(this.bcChannel,w._f(n),this);const o=w.Mf();w.uE(o,3),f(this.bcChannel,w._f(o),this);const i=w.Mf();w.uE(i,1),w.mP(i,U(this.awareness,[this.doc.clientID])),f(this.bcChannel,w._f(i),this)}disconnectBc(){const e=w.Mf();w.uE(e,1),w.mP(e,U(this.awareness,[this.doc.clientID],new Map)),T(this,w._f(e)),this.bcconnected&&(((e,t)=>{const s=_(e);s.subs.delete(t)&&0===s.subs.size&&(s.bc.close(),u.delete(e))})(this.bcChannel,this._bcSubscriber),this.bcconnected=!1)}disconnect(){this.shouldConnect=!1,this.disconnectBc(),null!==this.ws&&this.ws.close()}connect(){this.shouldConnect=!0,this.wsconnected||null!==this.ws||(P(this),this.connectBc())}}class R{constructor(e){this._onConnectionClosed=e=>{1003===e.code&&(console.error("Document provider closed:",e.reason),(0,n.showErrorMessage)(this._trans.__("Session expired"),this._trans.__("The document session expired. You need to reload this browser tab."),[n.Dialog.okButton({label:this._trans.__("Reload")})]).then((e=>{e.button.accept&&window.location.reload()})).catch((e=>window.location.reload())),this._sharedModel.dispose())},this._ready=new a.PromiseDelegate,this._isDisposed=!1,this._path=e.path,this._contentType=e.contentType,this._format=e.format,this._serverUrl=e.url,this._sharedModel=e.model,this._awareness=e.model.awareness,this._yWebsocketProvider=null,this._trans=e.translator;const t=e.user;t.ready.then((()=>{this._onUserChanged(t)})).catch((e=>console.error(e))),t.userChanged.connect(this._onUserChanged,this),this._connect()}get isDisposed(){return this._isDisposed}get ready(){return this._ready.promise}dispose(){var e,t;this.isDisposed||(this._isDisposed=!0,null===(e=this._yWebsocketProvider)||void 0===e||e.off("connection-close",this._onConnectionClosed),null===(t=this._yWebsocketProvider)||void 0===t||t.destroy(),c.Signal.clearData(this))}_connect(){(async function(e,t,s){const{makeSettings:n,makeRequest:a,ResponseError:c}=i.ServerConnection,r=n(),h=o.URLExt.join(r.baseUrl,"api/collaboration/session",encodeURIComponent(s)),d={method:"PUT",body:JSON.stringify({format:e,type:t})},l=await a(h,d,r);if(200!==l.status&&201!==l.status)throw new c(l);return l.json()})(this._format,this._contentType,this._path).then((e=>{this._yWebsocketProvider=new x(this._serverUrl,`${e.format}:${e.type}:${e.fileId}`,this._sharedModel.ydoc,{disableBc:!0,params:{sessionId:e.sessionId},awareness:this._awareness}),this._yWebsocketProvider.on("connection-close",this._onConnectionClosed)})).then((e=>this._ready.resolve())).catch((e=>console.warn(e)))}_onUserChanged(e){this._awareness.setLocalStateField("user",e.identity)}}class H extends i.Drive{constructor(e,t){super({name:"RTC"}),this._onCreate=(e,t)=>{if("string"==typeof e.format)try{const s=new R({url:o.URLExt.join(this.serverSettings.wsUrl,"api/collaboration/room"),path:e.path,format:e.format,contentType:e.contentType,model:t,user:this._user,translator:this._trans}),i=`${e.format}:${e.contentType}:${e.path}`;this._providers.set(i,s),t.disposed.connect((()=>{const e=this._providers.get(i);e&&(e.dispose(),this._providers.delete(i))}));for(const t of this._providers.keys()){if(t===i)continue;const s=t.split(":")[2];e.path===s&&(0,n.showDialog)({title:this._trans.__("Warning"),body:this._trans.__("Opening a document with multiple views simultaneously is not supported.Please, close one view otherwise, you might lose some of your changes."),buttons:[n.Dialog.okButton()]})}}catch(t){console.error(`Failed to open websocket connection for ${e.path}.\n:${t}`)}},this._user=e,this._trans=t,this._providers=new Map,this.sharedModelFactory=new B(this._onCreate)}dispose(){this.isDisposed||(this._providers.forEach((e=>e.dispose())),this._providers.clear(),super.dispose())}async get(e,t){if(t&&t.format&&t.type){const s=`${t.format}:${t.type}:${e}`,n=this._providers.get(s);if(n){const s=super.get(e,{...t,content:!1});return await n.ready,s}}return super.get(e,t)}async save(e,t={}){if(t.format&&t.type){const s=`${t.format}:${t.type}:${e}`;if(this._providers.get(s))return this.get(e,{...t,content:!1})}return super.save(e,t)}}class B{constructor(e){this._onCreate=e,this.collaborative=!0,this._documentFactories=new Map}registerDocumentFactory(e,t){if(this._documentFactories.has(e))throw new Error(`The content type ${e} already exists`);this._documentFactories.set(e,t)}createNew(e){if("string"==typeof e.format){if(e.collaborative&&this._documentFactories.has(e.contentType)){const t=this._documentFactories.get(e.contentType)(e);return this._onCreate(e,t),t}}else console.warn(`Only defined format are supported; got ${e.format}.`)}}const W=new a.Token("@jupyter/collaboration-extension:ICollaborativeDrive")}}]);