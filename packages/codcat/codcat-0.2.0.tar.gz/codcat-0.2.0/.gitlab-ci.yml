---
image: python:3.9

workflow:
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
    - if: $CI_COMMIT_REF_NAME == "main"

stages:
  - test
  - build
  - deploy


test:
  stage: test
  script:
    - apt-get update
    - LANG=en_US.UTF-8
    - |
      apt-get install -y locales && \
          sed -i -e "s/# $LANG.*/$LANG UTF-8/" /etc/locale.gen && \
          dpkg-reconfigure --frontend=noninteractive locales && \
          update-locale LANG=$LANG
    - pip install tox
    - tox


build:
  stage: build
  script:
    - python3 -m pip install --upgrade pip
    - pip3 install build
    - python3 -m build
  artifacts:
    paths:
      - dist/*.whl
      - dist/*.tar.gz
    expire_in: 1 week


publish_pypi:
  stage: deploy
  script:
    - pip install twine
    - python -m twine upload dist/*
  needs:
    - build
  rules:
    - if: $CI_COMMIT_TAG =~ /^v\d+\.\d+\.\d+$/
      when: always
    - if: $CI_PIPELINE_SOURCE == "merge_request_event"
      when: manual
      allow_failure: true
