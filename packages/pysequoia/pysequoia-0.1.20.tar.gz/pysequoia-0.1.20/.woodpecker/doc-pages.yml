pipeline:
  pages:
    image: woodpeckerci/plugin-docker-buildx
    settings:
      dockerfile: ci/docs.dockerfile
      output: type=local,dest=public
      # do not push, push cannot be used with output simultaneously anyway
      dry_run: true
      # do not refresh image
      pull_image: false
      purge: false

  docs-vale:
    # See: https://vale.sh/docs/vale-cli/installation/
    image: jdkato/vale
    group: build
    secrets: [ codeberg_token ]
    commands:
      - apk --no-cache add curl
      - >
        vale --output=JSON . |
        python ./ci/vale-to-review.py |
        curl -i -H"Content-Type: application/json" --data-binary @- -H "Authorization: token $CODEBERG_TOKEN" "https://codeberg.org/api/v1/repos/$CI_REPO/pulls/$CI_COMMIT_PULL_REQUEST/reviews"
    when:
      event: pull_request

  pages-publish:
    image: bitnami/git
    secrets: [ codeberg_token ]
    commands:
      - git config --global user.email bot+pages@metacode.biz
      - git config --global user.name "Page Renderer"
      - git clone -b pages https://$CODEBERG_TOKEN@codeberg.org/$CI_REPO.git $CI_REPO_NAME
      - cp -ar public/. $CI_REPO_NAME/
      # Needed for custom domains
      - cp .domains $CI_REPO_NAME || true # Ignore if it doesn't exist
      - cd $CI_REPO_NAME
      - >
        if [ -z "$(git status --porcelain)" ]; then
          echo "No changes"
        else
          git add .
          git commit -m "Update rendered page" -m "Source: $CI_COMMIT_SHA" -m "See: $CI_BUILD_LINK"
          git push
        fi
    when:
      event: push
