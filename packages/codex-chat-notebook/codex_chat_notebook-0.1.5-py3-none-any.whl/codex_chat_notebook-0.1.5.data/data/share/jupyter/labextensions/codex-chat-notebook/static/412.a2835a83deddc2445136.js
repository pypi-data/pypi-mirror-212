"use strict";(self.webpackChunkcodex_chat_notebook=self.webpackChunkcodex_chat_notebook||[]).push([[412],{1568:(e,t,o)=>{o.r(t),o.d(t,{default:()=>p});var n=o(6825),s=o(2138),i=o(3706),l=o(3931),a=o(7905),c=o(4198),r=o(608);class h{constructor(e){e.currentChanged.connect((e=>{this.notebook=e.currentWidget.children()._source[2]}))}createNew(e,t){const o=e.content;this.notebook=o,o._sessionContex=t.sessionContext;let i=new n.ToolbarButton({iconClass:"jp-RobotIcon",onClick:()=>{console.log(`Notebook "${o.title.label}" is now activated as the current chat notebook!`)},tooltip:"Chat Notebook is enabled"});return e.toolbar.insertItem(0,"activate",i),new s.DisposableDelegate((()=>{i.dispose(),this.notebook===o&&(this.notebook=null)}))}getState(e){return{wasFocused:e.node.contains(document.activeElement),activeCell:e.activeCell}}handleState(e,t,o=!1){const{activeCell:n,node:s}=e;(t.wasFocused||"edit"===e.mode)&&e.activate(),o&&n&&r.ElementExt.scrollIntoViewIfNeeded(s,n.node)}getCodeHistory(e,t){const o=this.notebook.model.cells,n=[];let s=!0;for(let i=0;i<o.length&&!(i>this.notebook.activeCellIndex);i++){const l=o.get(i);if("code"===l.type)s?(n.push({role:"assistant",content:`\n"""\n${e}\n"""\n${l.value.text}\n${t}`}),s=!1):n.push({role:"assistant",content:l.value.text});else if("markdown"===l.type){let o="";const i=l.value.text.split("\n");if(o+="## "+i[0].replace(/^(\#+\s)/,""),s||i.length>1){let n,l;l=s?e:"",n=i.length>1?i.slice(1).join("\n"):"",o+=`\n"""\n${l}\n${n}\n"""`,s&&(o+=`\n${t}`,s=!1)}n.push({role:"user",content:o})}}return n}addCell(e,t){const o=this.notebook;if(!o.model)return;const n=this.getState(o),s=o.model,i=s.contentFactory.createMarkdownCell({});i.value.text=e,s.cells.insert(o.activeCellIndex+1,i);const l=s.contentFactory.createCodeCell({});l.value.text=t,s.cells.insert(o.activeCellIndex+2,l),o.activeCellIndex+=2,this.notebook.lastCellIndex=o.activeCellIndex,this.notebook.lastCellNumber=2,o.deselectAll(),this.handleState(o,n,!0),setTimeout((async()=>{try{const e=await a.v.run(this.notebook,this.notebook._sessionContex);console.log(e)}catch(e){console.error(e)}}),0)}addMarkdown(e){const t=this.notebook;if(!t.model)return;const o=this.getState(t),n=model.contentFactory.createMarkdownCell({});n.value.text=e,model.cells.insert(t.activeCellIndex+1,n),t.activeCellIndex+=1,this.notebook.lastCellIndex=t.activeCellIndex,this.notebook.lastCellNumber=1,t.deselectAll(),this.handleState(t,o,!0)}runCell(){notebook.model&&notebook.activeCell&&a.v.run(this.notebook,this.notebook._sessionContex)}runAllCells(){a.v.runAll(this.notebook,this.notebook._sessionContex)}undoCell(){let e="";if(this.notebook.lastCellNumber&&this.notebook.lastCellNumber>0){for(let t=0;t<this.notebook.lastCellNumber;t++){const t=this.notebook.model.cells.get(this.notebook.activeCellIndex);t&&"markdown"===t.type&&t.value.text.trim().startsWith("# ")&&(e=t.value.text.trim().replace(/^(\#+\s)/,"")),a.v.cut(this.notebook),this.notebook.activeCellIndex=this.notebook.lastCellIndex-(this.notebook.lastCellNumber-1)}this.notebook.lastCellIndex=0,this.notebook.lastCellNumber=0,this.notebook.activeCellIndex-=1}else{const t=this.notebook.model.cells.get(this.notebook.activeCellIndex);t&&"markdown"===t.type&&t.value.text.trim().startsWith("# ")&&(e=t.value.text.trim().replace(/^(\#+\s)/,"")),a.v.cut(this.notebook),this.notebook.activeCellIndex-=1}return e}}async function d(e,t){t=e.base_url.replace(/\/$/,"")+"/"+t;const o=await fetch(t),n=(await o.text()).split("\n");let s="prompt",i="",l="";for(let e=0;e<n.length;e++)if("prompt"===s){if(n[e].startsWith("-----")){s="code";continue}i+=n[e]+"\n"}else{const t=n[e].replace(/```/g,"");""!==t.trim()&&(l+=t+"\n")}return{prefix:i.trim(),examples:l.trim()}}const p={id:"codex-chat-notebook",autoStart:!0,requires:[c.INotebookTracker],activate:function(e,t){const o=new h(t);e.docRegistry.addWidgetExtension("Notebook",o),console.log("JupyterLab extension codex-chat-notebook is activated!");class n extends i.Widget{constructor(){super(),this.addClass("content"),this.id="tutorial",this.title.label="Chat Notebook",this.title.closable=!0,this.createNode()}setupSpeech(){if("webkitSpeechRecognition"in window){let e=new webkitSpeechRecognition,t="",o=!1;e.continuous=!0,e.interimResults=!0,e.lang="en-US",this.speechButton.style.background="",e.onstart=()=>{o=!0,t="",this.speechButton.style.background="greenyellow"},e.onerror=()=>{o=!1,this.speechButton.style.background="red",console.log("Speech Recognition Error")},e.onend=()=>{o=!1,this.speechButton.style.background="",console.log("Speech Recognition Ended")},e.onresult=e=>{let o="";for(let n=e.resultIndex;n<e.results.length;++n)e.results[n].isFinal?(t+=e.results[n][0].transcript,this.inputBox.value=t):(o+=e.results[n][0].transcript,this.inputBox.value=o)},this.speechRecognition=e,this.speechButton.onclick=()=>{o?e.stop():e.start()}}else console.error("Speech Recognition Not Available"),this.speechButton.style.display="none"}async createNode(){this.repo=await async function(){const e=await fetch("https://raw.githubusercontent.com/oeway/codex-chat-notebook/master/codex-prompt-repository/index.json");return await e.json()}(),this.node.innerHTML='<h2 style="color: slategrey;font-family: monospace;">Chat Notebook</h2><p>Built with LLM from OpenAI, by Wei Ouyang</p>',this.node.style.padding="10px",this.node.style.background="white",this.node.style.height="100%",this.node.style.overflow="auto",this.modelSelect=document.createElement("select"),this.modelSelect.style.display="block",this.modelSelect.style.width="100%",this.modelSelect.style.marginTop="10px",this.modelSelect.style.color="black",this.modelSelect.title="Model",this.tokenInput=document.createElement("input"),this.tokenInput.style.display="block",this.tokenInput.style.width="100%",this.tokenInput.style.color="gray",this.tokenInput.type="password",this.tokenInput.placeholder="OpenAI API token",this.tokenInput.title="OpenAI API token",this.promptSelect=document.createElement("select"),this.promptSelect.style.display="block",this.promptSelect.style.width="100%",this.promptSelect.style.marginTop="10px",this.promptSelect.style.color="black",this.promptSelect.title="Prompt",this.promptDetails=document.createElement("p"),this.promptDetails.style.display="block",this.promptDetails.style.width="100%",this.promptDetails.style.color="gray",this.repo.items.forEach((e=>{const t=document.createElement("option");t.value=e.source,t.title=e.description,t.innerText=e.name,this.promptSelect.appendChild(t)})),this.inputBox=document.createElement("textarea"),this.inputBox.style.marginTop="10px",this.inputBox.style.display="block",this.inputBox.style.width="100%",this.inputBox.style.height="6rem",this.inputBox.style.fontSize="16px",this.speechButton=document.createElement("button"),this.speechButton.innerHTML="Voice",this.speechButton.style.width="50%",this.speechButton.style.height="20px",this.speechButton.style.fontSize="16px",this.speechButton.style.display="inline-block",this.speechButton.classList.add("bp3-button","bp3-minimal","jp-ToolbarButtonComponent","minimal","jp-Button"),this.undoButton=document.createElement("button"),this.undoButton.style.width="50%",this.undoButton.style.height="20px",this.undoButton.style.fontSize="16px",this.undoButton.innerHTML="Undo",this.undoButton.style.display="inline-block",this.undoButton.classList.add("bp3-button","bp3-minimal","jp-ToolbarButtonComponent","minimal","jp-Button"),this.executeButton=document.createElement("button"),this.executeButton.innerHTML="Execute",this.executeButton.style.display="block",this.executeButton.style.background="lavender",this.executeButton.style.fontSize="16px",this.executeButton.style.width="100%",this.executeButton.classList.add("bp3-button","bp3-minimal","jp-ToolbarButtonComponent","minimal","jp-Button"),this.node.appendChild(this.modelSelect),this.node.appendChild(this.tokenInput),this.node.appendChild(this.promptSelect),this.node.appendChild(this.promptDetails),this.node.appendChild(this.inputBox),this.node.appendChild(this.speechButton),this.node.appendChild(this.undoButton),this.node.appendChild(this.executeButton),this.requestedCodeElm=document.createElement("pre"),this.requestedCodeElm.style.color="gray",this.respondCodeElm=document.createElement("pre"),this.respondCodeElm.style.color="blue",this.node.appendChild(this.respondCodeElm),this.node.appendChild(this.requestedCodeElm);const e=()=>{fetch("https://api.openai.com/v1/models",{method:"GET",headers:{Authorization:"Bearer "+this.tokenInput.value,"Content-Type":"application/json"}}).then((e=>e.json())).then((e=>{e.data.forEach((e=>{let t=document.createElement("option");t.text=e.id,t.value=e.id,this.modelSelect.add(t),this.modelSelect.value=localStorage.getItem("openai-model")||"gpt-3.5-turbo"}))})).catch((e=>{console.error("Error:",e)}))};let t;this.modelSelect.onchange=()=>{localStorage.setItem("openai-model",this.modelSelect.value)};const n=localStorage.getItem("openai-token");if(n){const o=new l.Configuration({apiKey:n});t=new l.OpenAIApi(o),this.tokenInput.value=n,e()}this.tokenInput.onchange=()=>{const o=new l.Configuration({apiKey:this.tokenInput.value});t=new l.OpenAIApi(o),localStorage.setItem("openai-token",this.tokenInput.value),e()},this.promptPrefix='# Generate code for Jupyter notebooks\nI start with an empty jupyter notebook with Python 3 kernel, and incrementally add instructions for each cell. The instructions are comment string starts with "##" (with additional details are provided as quoted with """) the lines after the instructions or details should be a generated executable Python 3 code block or empty.\nThe instructions are given by a human via a speech-to-text program in a noisy environment, therefore the text maybe confusing and requires correction but the general context is using python for data analysis.\nThe result of each code block should be printed or displayed in the notebook.\n\nFor all the instructions, the generated code should be as simple as possible, and the code should be able to run in the current notebook.\nIf you are not sure about the instructions, you can ask for clarification by adding a comment line starts with "##?" and the details of the question.\n\nIn the following cases, it should generate a special command string instead of a python code block:\n - To cancel or undo last cell, generate "%undo"\n - To execute all the cells, generate "%run-all"\n - To execute the current or active cell, generate "%run"\n',this.codeExamples='## Print hello world\nprint("Hello world")\n',d(this.repo,this.promptSelect.value).then((e=>{this.promptPrefix=e.prefix,this.codeExamples=e.examples})),this.promptSelect.onchange=()=>{this.selectedPrompt=this.promptSelect.value;const e=this.repo.items.find((e=>e.source===this.selectedPrompt));this.promptSelect.title="Select a prompt template for your task.",this.promptDetails.innerHTML=e.description,d(this.repo,this.selectedPrompt).then((e=>{this.promptPrefix=e.prefix,this.codeExamples=e.examples})).catch((e=>{console.error(e),alert("Failed to fetch prompt: "+this.selectedPrompt)}))},this.executeButton.onclick=async()=>{this.respondCodeElm.innerHTML="",this.speechRecognition&&this.speechRecognition.stop();const e=(n=this.inputBox.value.trim())&&n[0].toUpperCase()+n.slice(1);var n;if(e.length<=0)return;const s=e.split("\n");let i="## "+s[0].replace(/^(\#+\s)/,"");s.length>1&&(i+='\n"""\n'+s.slice(1).join("\n")+'\n"""');const l=o.getCodeHistory("",this.codeExamples);l.unshift({role:"system",content:this.promptPrefix}),l.push({role:"user",content:i}),this.requestedCodeElm.innerHTML="==== Request Prompt ====\n"+l.map((e=>e.content)).join("\n"),this.executeButton.style.background="LightGoldenRodYellow";try{const n=await t.createChatCompletion({model:this.modelSelect.value,messages:l,temperature:.1});console.log(n.data);const s=n.data.choices[0].message.content.trim();if(this.respondCodeElm.innerHTML="==== Generated Code ====\n\n"+s,s.startsWith("%undo"))this.undoButton.onclick();else if(s.startsWith("%run"))o.runCell();else if(s.startsWith("%run-all"))o.runAllCells();else if(s.startsWith("%markdown")){const e=s.substring(10);o.addMarkdown(e)}else o.addCell("# "+e.trim(),s)}catch(e){console.error(e),alert(`Failed to execute: ${e}`)}this.executeButton.style.background="lavender",this.inputBox.value=""},this.undoButton.onclick=async()=>{if(this.speechRecognition&&this.speechRecognition.stop(),this.inputBox.value.trim().length>0)this.inputBox.value="";else{const e=o.undoCell();this.inputBox.value=e.split("\n")[0]}},this.inputBox.addEventListener("keydown",(e=>{"Enter"!=e.key||e.shiftKey||(this.executeButton.onclick(),e.preventDefault())})),this.setupSpeech()}}const s=new i.Panel;s.id="Codex-Chat-Panel",s.title.iconClass="jp-RobotIcon",s.addWidget(new n),e.shell.add(s,"left",{rank:1})}}}}]);