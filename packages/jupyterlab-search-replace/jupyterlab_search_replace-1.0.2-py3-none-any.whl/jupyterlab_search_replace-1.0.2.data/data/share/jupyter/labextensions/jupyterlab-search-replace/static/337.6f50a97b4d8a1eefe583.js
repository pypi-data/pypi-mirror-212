"use strict";(self.webpackChunkjupyterlab_search_replace=self.webpackChunkjupyterlab_search_replace||[]).push([[337],{770:(e,t,a)=>{a.r(t),a.d(t,{default:()=>A});var r=a(763),s=a(764),l=a(263),n=a(680),i=a(883),c=a(85),o=a(414),h=a(667),u=a(526),p=a(114),m=a(58),d=a(872);async function g(e="",t={}){const a=d.ServerConnection.makeSettings(),r=m.URLExt.join(a.baseUrl,"search",e);let s;try{s=await d.ServerConnection.makeRequest(r,t,a)}catch(e){throw new d.ServerConnection.NetworkError(e)}let l=await s.text();if(l.length>0)try{l=JSON.parse(l)}catch(e){console.log("Not a JSON response body.",s)}if(!s.ok)throw new d.ServerConnection.ResponseError(s,l.message||l);return l}const _=/\$[1-9]\d*/g;class f extends s.VDomModel{constructor(){super(),this._errorMsg=null,this._isLoading=!1,this._searchQuery="",this._queryResults=[],this._caseSensitive=!1,this._wholeWord=!1,this._useRegex=!1,this._excludeFilters="",this._includeFilters="",this._path="",this._replaceString="",this._replaceWorker=null,this._defaultExcludeFilters=[],this._maxLinesPerFile=100,this._debouncedSearch=new p.dx((async()=>{await this.search()}))}get caseSensitive(){return this._caseSensitive}set caseSensitive(e){e!==this._caseSensitive&&(this._caseSensitive=e,this.stateChanged.emit(),this.refresh())}get defaultExcludeFilters(){return this._defaultExcludeFilters}set defaultExcludeFilters(e){u.JSONExt.deepEqual(e,this._defaultExcludeFilters)||(this._defaultExcludeFilters=e,this.stateChanged.emit(),this.refresh())}get error(){return this._errorMsg}get excludeFilters(){return this._excludeFilters}set excludeFilters(e){e!==this._excludeFilters&&(this._excludeFilters=e,this.stateChanged.emit(),this.refresh())}get includeFilters(){return this._includeFilters}set includeFilters(e){e!==this._includeFilters&&(this._includeFilters=e,this.stateChanged.emit(),this.refresh())}get isLoading(){return this._isLoading}set isLoading(e){e!==this._isLoading&&(this._isLoading=e,this.stateChanged.emit())}get path(){return this._path}set path(e){e!==this._path&&(this._path=e,this.stateChanged.emit(),this.refresh())}get queryResults(){return this._queryResults}get maxLinesPerFile(){return this._maxLinesPerFile}set maxLinesPerFile(e){e>=1&&e!==this._maxLinesPerFile&&(this._maxLinesPerFile=e,this.stateChanged.emit(),this.refresh())}get replaceString(){return this._replaceString}set replaceString(e){e!==this._replaceString&&(this._replaceString=e,this.stateChanged.emit(),this._updateReplace().then((()=>{this.stateChanged.emit()})).catch((e=>{console.error(`Failed to update replace expression.\n${e}`)})))}get searchQuery(){return this._searchQuery}set searchQuery(e){e!==this._searchQuery&&(this._searchQuery=e,this.stateChanged.emit(),this.refresh())}get useRegex(){return this._useRegex}set useRegex(e){e!==this._useRegex&&(this._useRegex=e,this.stateChanged.emit(),this.refresh())}get wholeWord(){return this._wholeWord}set wholeWord(e){e!==this._wholeWord&&(this._wholeWord=e,this.stateChanged.emit(),this.refresh())}refresh(){this._debouncedSearch.invoke().catch((e=>console.error(`Failed to invoke search.\n${e}`)))}async replace(e){var t;try{await g(this.path,{method:"POST",body:JSON.stringify({matches:e})}),this._errorMsg=null}catch(e){console.error(`Failed to replace some matches.\n${e}`),this._errorMsg=null!==(t=e.message)&&void 0!==t?t:e}finally{this.refresh()}}async search(){var e;const t=this.searchQuery,a=this.path;if(""===t)return this._errorMsg=null,this._queryResults=[],this.stateChanged.emit(),Promise.resolve();try{this.isLoading=!0;const e=[["query",t],["case_sensitive",this.caseSensitive.toString()],["whole_word",this.wholeWord.toString()],["use_regex",this.useRegex.toString()],["max_count",this.maxLinesPerFile.toString()]];e.push(...this.excludeFilters.split(",").concat(this.defaultExcludeFilters).map((e=>e.trim())).filter((e=>e)).map((e=>["exclude",e]))),e.push(...this.includeFilters.split(",").map((e=>e.trim())).filter((e=>e)).map((e=>["include",e])));const r=await g(a+"?"+new URLSearchParams(e).toString(),{method:"GET"});this._queryResults=r.matches,this._errorMsg=null,this.replaceString&&await this._updateReplace()}catch(r){console.error(`Failed to search for '${t}' in '${a}'.`,r),this._errorMsg=null!==(e=r.message)&&void 0!==e?e:r,this._queryResults=[]}finally{this._isLoading=!1,this.stateChanged.emit()}}async _updateReplace(){const e=(e=null)=>{this._queryResults.forEach((t=>{t.matches.forEach((t=>{t.replace=e}))}))};if(null===this.replaceString.match(_))e(this.replaceString?this.replaceString:null);else{window.Worker||(console.error("Failed to build complex replacement expression because your browser does not support WebWorker."),e()),this._replaceWorker&&this._replaceWorker.terminate(),this._replaceWorker=new Worker(new URL(a.p+a.u(641),a.b));const t=new u.PromiseDelegate;this._replaceWorker.onerror=e=>{t.reject(e)},this._replaceWorker.onmessage=e=>{this._queryResults=e.data,t.resolve()},this._replaceWorker.postMessage([this.searchQuery,this.caseSensitive?"":"i",this.replaceString,this.queryResults]);try{await t.promise}catch(t){console.error(`Failed to build complex replacement expression.\n${t}`),e()}finally{this._replaceWorker.terminate(),this._replaceWorker=null}}}}var E=a(300),x=a(271),y=a.n(x),R=a(832);class S extends R.Widget{constructor(e,t){super({node:S.createNode(e,t)}),this._checkbox=this.node.querySelector('.jp-ask-checkbox > input[type="checkbox"]')}getValue(){return this._checkbox.checked}static createNode(e,t){const a=document.createElement("div");return a.insertAdjacentHTML("afterbegin",`<div><p>${e}</p></div>\n      <label class="jp-ask-checkbox"><input type="checkbox"></input>${t}</label>`),a}}var w=a(986),k=a(489),F=a(131),b=a(992),C=a(812);const v=new h.LabIcon({name:"search-replace:wholeWord",svgstr:w.Z}),j=new h.LabIcon({name:"search-replace:expandAll",svgstr:k.Z}),N=new h.LabIcon({name:"search-replace:collapseAll",svgstr:F.Z}),I=new h.LabIcon({name:"search-replace:replaceAll",svgstr:b.Z}),L=new h.LabIcon({name:"search-replace:replace",svgstr:C.Z});function P(e){const{matches:t,path:a,expandStatus:r,maxMatchesPerFiles:s,setExpandStatus:l,onMatchClick:n,onReplace:i,trans:c}=e;if(0===t.length)return null;t.sort(((e,t)=>e.path>t.path?1:-1));const o=t.map(((e,t)=>{const o=e.matches.length>=s;return y().createElement(E.TreeItem,{className:"search-tree-files",expanded:r[t],onClick:()=>{const e=[...r];e[t]=!e[t],l(e)}},y().createElement("span",{title:e.path},e.path),i&&y().createElement(E.Button,{className:"jp-search-replace-item-button jp-mod-icon-only",appearance:"neutral",title:c.__("Replace All in File"),onClick:t=>{t.stopPropagation();const r=[{path:e.path,matches:e.matches}];i(r,m.PathExt.join(a,e.path))}},y().createElement(I.react,null)),o?y().createElement(E.Badge,{slot:"end",fill:"warning",color:"warning",title:c.__("Maximal number of matches is reached for this file. You can increase it in the settings.")},e.matches.length,o&&"+"):y().createElement(E.Badge,{slot:"end"},e.matches.length),e.matches.map((t=>{const r=i&&null!==t.replace;return y().createElement(E.TreeItem,{className:"search-tree-matches",onClick:r=>{r.stopPropagation(),n(m.PathExt.join(a,e.path),t)}},y().createElement("span",{title:t.line.trim()},t.line.slice(0,t.start_utf8),r?y().createElement(y().Fragment,null,y().createElement("del",null,t.match),y().createElement("ins",null,t.replace)):y().createElement("mark",null,t.match),t.line.slice(t.end_utf8)),r&&y().createElement(E.Button,{className:"jp-search-replace-item-button jp-mod-icon-only",appearance:"neutral",title:c.__("Replace"),onClick:r=>{r.stopPropagation();const s=[{path:e.path,matches:[t]}];i(s,m.PathExt.join(a,e.path))}},y().createElement(L.react,null)))})))}));return y().createElement("div",{className:"jp-search-replace-list"},y().createElement(E.TreeView,null,o))}class W extends s.VDomRenderer{constructor(e,t,a,r,s,l){super(e),this.commands=t,this.docManager=a,this.sanitizer=r,this.trans=s,this.onAskReplaceChanged=l,this._askReplaceConfirmation=!0,this.searchInputRef=y().createRef(),this.addClass("jp-search-replace-tab"),this.addClass("jp-search-replace-column")}get askReplaceConfirmation(){return this._askReplaceConfirmation}set askReplaceConfirmation(e){this._askReplaceConfirmation!==e&&(this._askReplaceConfirmation=e,this.onAskReplaceChanged(e))}onAfterShow(e){var t;super.onAfterShow(e),null===(t=this.searchInputRef.current)||void 0===t||t.focus()}render(){const e=this.model.queryResults.map((e=>e.path)),t=e.length,a=this.model.queryResults.reduce(((e,t)=>e+t.matches.length),0);let r=!1;if(this.docManager)for(const t of e){const e=this.docManager.findWidget(m.PathExt.join(this.model.path,t));if(e){const t=this.docManager.contextForWidget(e);if(null==t?void 0:t.model.dirty){r=!0;break}}}return y().createElement(M,{searchInputRef:this.searchInputRef,searchString:this.model.searchQuery,onSearchChanged:e=>{this.model.searchQuery=e},replaceString:this.model.replaceString,onReplaceString:e=>{this.model.replaceString=e},onReplace:async(e,r)=>{if(r)await this.replaceInFile(r,e[0].matches),this.model.refresh();else{if(this.askReplaceConfirmation){const e=await(0,s.showDialog)({title:this.trans.__("Replace All"),body:new S(this.trans._n("Replace %2 matche(s) accross %1 file with %3? This cannot be undone.","Replace %2 matches accross %1 files with %3? This cannot be undone.",t,a,this.model.replaceString),this.trans.__("Skip confirmation next time.")),buttons:[s.Dialog.cancelButton({label:this.trans.__("Cancel")}),s.Dialog.okButton({label:this.trans.__("Replace")})]});if(!e.button.accept)return;!0===e.value&&(this.askReplaceConfirmation=!1)}await this.model.replace(e)}},isLoading:this.model.isLoading,queryResults:this.model.error?[]:this.model.queryResults,onMatchClick:(e,t)=>{this.openFile(e,t)},refresh:()=>{this.model.refresh()},path:this.model.path,onPathChanged:e=>{this.model.path=e},maxLinesPerFile:this.model.maxLinesPerFile,options:y().createElement(y().Fragment,null,y().createElement(E.Button,{className:"jp-mod-icon-only",title:this.trans.__("Match Case"),appearance:this.model.caseSensitive?"accent":"neutral",onClick:()=>{this.model.caseSensitive=!this.model.caseSensitive}},y().createElement(h.caseSensitiveIcon.react,null)),y().createElement(E.Button,{className:"jp-mod-icon-only",title:this.trans.__("Match Whole Word"),appearance:this.model.wholeWord?"accent":"neutral",onClick:()=>{this.model.wholeWord=!this.model.wholeWord}},y().createElement(v.react,null)),y().createElement(E.Button,{className:"jp-mod-icon-only",title:this.trans.__("Use Regular Expression"),appearance:this.model.useRegex?"accent":"neutral",onClick:()=>{this.model.useRegex=!this.model.useRegex}},y().createElement(h.regexIcon.react,null))),trans:this.trans},y().createElement(T,{includeFilters:this.model.includeFilters,excludeFilters:this.model.excludeFilters,onIncludeFiltersChange:e=>{this.model.includeFilters=e},onExcludeFiltersChange:e=>{this.model.excludeFilters=e},trans:this.trans}),this.model.error?y().createElement("div",{className:"jp-search-replace-warning"},y().createElement("p",{dangerouslySetInnerHTML:{__html:"ripgrep command not found."===this.model.error?this.sanitizer.sanitize(this.trans.__('<a href="%1" target="_blank">ripgrep</a> command was not found. You can install it using e.g. the <a href="%2" target="_blank">conda package manager</a>.',"https://github.com/BurntSushi/ripgrep#installation","https://anaconda.org/conda-forge/ripgrep")):this.model.error}})):y().createElement(y().Fragment,null,r&&y().createElement("div",{className:"jp-search-replace-warning"},y().createElement("p",null,this.trans.__("You have unsaved changes. The result(s) may be inexact. Save your work and refresh."))),this.model.searchQuery&&y().createElement("p",{className:"jp-search-replace-statistics"},this.model.queryResults.length?this.trans._n("%2 result(s) in %1 file","%2 results in %1 files",t,a):this.trans.__("No results found."))))}async openFile(e,t){const a=await this.commands.execute("docmanager:open",{factory:"Editor",path:e});return t&&(await a.context.ready,a.content.editor.doc.setSelection({line:t.line_number-1,ch:t.start_utf8},{line:t.line_number-1,ch:t.end_utf8})),a}async replaceInFile(e,t){const a=await this.openFile(e);await a.context.ready;const r=a.content.editor;return t.sort(((e,t)=>e.line_number<t.line_number?1:e.line_number===t.line_number?e.start<t.start?1:e.start===t.start?0:-1:-1)).forEach((e=>{r.doc.setSelection({line:e.line_number-1,ch:e.start_utf8},{line:e.line_number-1,ch:e.end_utf8}),null!==e.replace&&r.doc.replaceSelection(e.replace)})),await this.commands.execute("docmanager:save"),a}}const q=y().memo((e=>{const t=e.path.split("/");return y().createElement(E.Breadcrumb,{className:"jp-search-replace-breadcrumb"},y().createElement(E.BreadcrumbItem,{key:"root",className:"jp-search-replace-breacrumbitem",title:"/"},y().createElement(E.Button,{className:"jp-mod-icon-only",appearance:"stealth",onClick:()=>{e.onPathChanged("")}},y().createElement(h.folderIcon.react,null))),e.path&&t.map(((a,r)=>{const s=t.slice(0,r+1).join("/");return y().createElement(E.BreadcrumbItem,{key:a,className:"jp-search-replace-breacrumbitem",style:{flexGrow:r+1,flexShrink:t.length-r-1},title:"/"+s},y().createElement(E.Button,{className:"jp-search-replace-pathbutton",appearance:"lightweight",onClick:()=>{e.onPathChanged(s)}},a))})))})),M=e=>{const[t,a]=(0,x.useState)(!1),[r,s]=(0,x.useState)(new Array(e.queryResults.length).fill(!0));(0,x.useEffect)((()=>{s(new Array(e.queryResults.length).fill(!0))}),[e.queryResults]);const l=r.some((e=>e)),n=t&&""!==e.replaceString&&e.queryResults.length>0;return y().createElement(y().Fragment,null,y().createElement("div",{className:"jp-stack-panel-header jp-search-replace-column"},y().createElement("div",{className:"jp-search-replace-header jp-search-replace-row"},y().createElement("h2",null,e.trans.__("Search")),y().createElement("div",{className:"jp-Toolbar-spacer"}),y().createElement(E.Toolbar,null,y().createElement(E.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Refresh"),onClick:()=>{e.refresh()}},y().createElement(h.refreshIcon.react,null)),y().createElement(E.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:l?e.trans.__("Collapse All"):e.trans.__("Expand All"),disabled:0===e.queryResults.length,onClick:()=>{const t=new Array(e.queryResults.length).fill(!l);s(t)}},l?y().createElement(N.react,null):y().createElement(j.react,null)))),y().createElement(q,{path:e.path,onPathChanged:e.onPathChanged})),y().createElement("div",{className:"jp-search-replace-row jp-search-replace-collapser"},y().createElement(E.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Toggle Replace"),onClick:()=>{a(!t)}},t?y().createElement(h.caretDownIcon.react,null):y().createElement(h.caretRightIcon.react,null)),y().createElement("div",{className:"jp-search-replace-column"},y().createElement("div",{className:"jp-search-replace-row"},y().createElement(E.TextField,{ref:e.searchInputRef,appearance:"outline",type:"text",placeholder:e.trans.__("Search"),"aria-label":e.trans.__("Search Files for Text"),onChange:t=>{e.onSearchChanged(t.target.value)},onInput:t=>{e.onSearchChanged(t.target.value)},value:e.searchString}),y().createElement(E.Toolbar,null,e.options)),t&&y().createElement("div",{className:"jp-search-replace-row"},y().createElement(E.TextField,{appearance:"outline",placeholder:e.trans.__("Replace"),onInput:t=>{e.onReplaceString(t.target.value)},value:e.replaceString}),y().createElement(E.Button,{className:"jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Replace All"),disabled:!n,onClick:()=>{e.onReplace(e.queryResults)}},y().createElement(I.react,null))))),e.children,e.isLoading?y().createElement(E.Progress,null):e.searchString&&y().createElement(P,{matches:e.queryResults,path:e.path,expandStatus:r,maxMatchesPerFiles:e.maxLinesPerFile,onMatchClick:e.onMatchClick,setExpandStatus:s,onReplace:n?e.onReplace:null,trans:e.trans}))},T=y().memo((e=>{const[t,a]=(0,x.useState)(!1),{includeFilters:r,onIncludeFiltersChange:s,excludeFilters:l,onExcludeFiltersChange:n,trans:i}=e;return y().createElement("div",{className:"jp-search-replace-filtersBox jp-search-replace-column"},y().createElement(E.Button,{className:"jp-search-replace-filters-collapser jp-mod-icon-only",appearance:"stealth",title:e.trans.__("Toggle Search Filters"),onClick:()=>{a(!t)}},y().createElement(h.ellipsesIcon.react,null)),t&&y().createElement(y().Fragment,null,y().createElement("label",{className:"jp-search-replace-column"},i.__("Include file filters"),y().createElement(E.TextField,{appearance:"outline",placeholder:i.__("e.g. *.py, src/**/include"),onChange:e=>{s(e.target.value)},onInput:e=>{s(e.target.value)},value:r})),y().createElement("label",{className:"jp-search-replace-column"},i.__("Exclude file filters"),y().createElement(E.TextField,{appearance:"outline",placeholder:i.__("e.g. *.py, src/**/exclude"),onChange:e=>{n(e.target.value)},onInput:e=>{n(e.target.value)},value:l}))))})),B={id:"jupyterlab-search-replace:plugin",autoStart:!0,requires:[s.ISanitizer,n.IFileBrowserFactory,i.IEditorTracker],optional:[l.IDocumentManager,c.ISettingRegistry,o.ITranslator],activate:(e,t,a,s,l,n,i)=>{const c=(null!=i?i:o.nullTranslator).load("search_replace");(0,r.addJupyterLabThemeChangeListener)();const u=new f;let p=null;const m=new W(u,e.commands,l,t,c,(async e=>{p&&await p.set("askReplaceAllConfirmation",e)}));n&&n.load(B.id).then((e=>{p=e;const t=e=>{u.defaultExcludeFilters=e.get("exclude").composite,u.maxLinesPerFile=e.get("maxLinesPerFile").composite,m.askReplaceConfirmation=e.get("askReplaceAllConfirmation").composite};t(e),e.changed.connect(t)})).catch((e=>{console.error(`Failed to load settings ${B.id}.`,e)}));const d=a.defaultBrowser;Promise.all([e.restored,d.model.restored]).then((()=>{u.path=d.model.path})),d.model.pathChanged.connect(((e,t)=>{u.path=t.newValue})),m.title.caption=c.__("Search and Replace"),m.id="jp-search-replace",m.title.icon=h.searchIcon,e.shell.add(m,"left")}},A=B}}]);