syntax = "proto3";

import "google/protobuf/timestamp.proto";

import "account.proto";
import "push_notification.proto";
import "billing.proto";
import "conversation.proto";
import "collaboration_entity.proto";
import "entity.proto";
import "common.proto";
import "automation_log.proto";
import "condition.proto";
import "automation.proto";
import "metric.proto";

option java_package = "io.calixa.domain.search";
option java_multiple_files = true;
option optimize_for = SPEED;

package calixa.domain.search;

message GlobalSearchRequest {
  string organization_id = 1;
  string query = 2;
  int32 page = 3;
  int32 hits_per_page = 4;
}

message GlobalSearchResponse {
  repeated calixa.domain.entity.EntityWithRelationships entities = 1;
}



message MetricWithTimeRange {
  string metric_descriptor_id = 1;
  oneof metric_range {
    calixa.domain.condition.RelativeTimeRange relative_time_range = 2;
    calixa.domain.condition.AbsoluteTimeRange absolute_time_range = 3;
  }
}

enum SortType {
  SORT_TYPE_UNSPECIFIED = 0;
  SORT_TYPE_PROPERTY = 1; // limited capability
  SORT_TYPE_METRIC = 2;
  SORT_TYPE_DELTA = 3;
  SORT_TYPE_SCORING_FUNCTION = 4;
  SORT_TYPE_JOURNEY = 5;
  SORT_TYPE_PREDICTION = 6;
}

message SearchSortField {
  SortType sort_type = 1;
  string sort_field_type = 2;
  string sort_field = 3;
  bool sort_asc = 4;
}

enum FeatureValueDistributionType {
  FEATURE_VALUE_DISTRIBUTION_TYPE_UNSPECIFIED = 0;
  FEATURE_VALUE_DISTRIBUTION_TYPE_HISTOGRAM = 1;
  FEATURE_VALUE_DISTRIBUTION_TYPE_TOP_N = 2;
}

message FeatureValueDistributionRequest {

  string organization_id = 1;
  calixa.domain.common.EntityType entity_type = 2;
  calixa.domain.condition.ConditionGroup filters = 3;

  // Only support TOPN for now
  FeatureValueDistributionType distribution_type = 4;
  int32 limit = 5; // Only used for TopN currently

  calixa.domain.condition.RelativeTimeRange timeframe = 6;

  string field = 10;
}

message FeatureValue {
  oneof value {
    string s = 1;
    int64 l = 2;
    double d = 3;
  }
  int64 count = 100;
  double fraction = 101;
}

message FeatureValueDistributionResponse {
  repeated FeatureValue distribution = 1;
  int64 total_results = 2;
  int64 distinct_values_count = 3;
}

message TrendSearchRequest {
  reserved 4, 7, 8, 9, 10; //deprecated fields
  string organization_id = 1;
  calixa.domain.common.EntityType entity_type = 2;
  calixa.domain.condition.ConditionGroup condition = 3;
  int32 page = 5;
  int32 hits_per_page = 6;
  repeated calixa.domain.condition.ConditionOrGroup columns = 11;
  repeated SearchSortField sort_fields = 12;
  calixa.domain.condition.RelativeTimeRange timeframe = 13;
  // temporary boolean to trigger
  reserved 99999; // bool isRocksetQuery = 99999;
}

message TrendSearchEntity {
  calixa.domain.entity.EntityWithRelationships ewr = 1;
  map<string, calixa.domain.metric.AggregatedMetric> aggregated_metrics = 2;
}

message TrendSearchResponse {
  int64 total_hits = 1;
  int64 page = 2;
  int64 total_pages = 3;
  int64 hits_per_page = 4;

  // This is the TOTAL time of the method call to perform the search and
  // all other related subtasks (fetching documents, metrics, associated
  // entities, etc).
  int64 processing_time_ms = 5;

  repeated TrendSearchEntity entities = 6;

  // New fields for capturing latency subtasks in the search call
  int64 latency_index_lookup_ms = 7; // Rockset time
  int64 latency_doc_lookup_ms = 8;   // Bigtable time
}

