syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "google/protobuf/empty.proto";
import "common.proto";
import "integration_source.proto";
import "oltpannotation.proto";

option java_package = "io.calixa.domain.audience";
option java_multiple_files = true;
option optimize_for = SPEED;

package calixa.domain.audience;


enum SyncState {
  SYNC_STATE_UNSPECIFIED = 0;
  SYNC_STATE_SCHEDULED = 1;
  SYNC_STATE_IN_PROGRESS = 2;
}

enum SyncStrategy {
  SYNC_STRATEGY_UNSPECIFIED = 0;
  SYNC_STRATEGY_UPDATE = 1;
  SYNC_STRATEGY_UPSERT = 2;
  SYNC_STRATEGY_SYNC = 3;
}

enum AudienceSyncState {
  AUDIENCE_SYNC_STATE_UNSPECIFIED = 0;
  AUDIENCE_SYNC_STATE_ENABLED = 1;
  AUDIENCE_SYNC_STATE_PAUSED = 2;
}

enum SyncSchedule {
  SYNC_SCHEDULE_UNSPECIFIED = 0;
  SYNC_SCHEDULE_DAILY = 1;
  SYNC_SCHEDULE_MANUALLY = 2;
  SYNC_SCHEDULE_TWICE_DAILY = 3;
}

enum SyncFieldEncoding {
  SYNC_FIELD_ENCODING_UNSPECIFIED = 0;
  SYNC_FIELD_ENCODING_NONE = 1;
  SYNC_FIELD_ENCODING_BASIC = 2;
  SYNC_FIELD_ENCODING_SHA512 = 3;
}

message SyncField {
  oneof field {
    string internal_field = 1;
    // TODO (luis): Add metric sync field
  }
  string external_field = 2;
  SyncFieldEncoding encoding = 3;
}

message SalesforceContactSync {
  // Only allows SalesforceContact and SalesforceLead
  common.EntityType entity_type = 1;

  // The properties to map from our entity models to external entity (these are mappings of field to field)
  repeated SyncField mappings = 2 [(calixa.oltp.oltp_field) = {nullable: false}];

  int32 sync_batch_limit = 3 [(calixa.oltp.oltp_field) = {nullable: false, default_value: {number_value: 1000}}];
}

message AudienceDestinationConfig {
  calixa.domain.integration.IntegrationSource destination = 1;
  oneof sync {
    SalesforceContactSync salesforce_contact_sync = 2;
  }
}

message AudienceSync {
  option (calixa.oltp.oltp_primary_key) = {field_ids: [1, 3]};

  string organization_id = 1;
  string audience_id = 2;
  string audience_sync_id = 3;
  string created_by_organization_user_id = 100 [(calixa.oltp.oltp_field) = {nullable: false}];

  SyncStrategy strategy = 4;
  SyncSchedule schedule = 5;
  SyncState sync_state = 6 [(calixa.oltp.oltp_field) = {nullable: false}];
  AudienceSyncState state = 7;
  AudienceDestinationConfig config = 8 [(calixa.oltp.oltp_field) = {nullable: false}];
  string instance_id = 9;

  AudienceSyncLogState last_sync_result = 10 [(calixa.oltp.oltp_field) = {nullable: true}];
  google.protobuf.Timestamp last_synced_at = 11 [(calixa.oltp.oltp_field) = {nullable: true}];
  google.protobuf.Timestamp next_sync_at = 12 [(calixa.oltp.oltp_field) = {nullable: true}];

  google.protobuf.Timestamp created_at = 13 [(calixa.oltp.oltp_field) = {nullable: false}];
  google.protobuf.Timestamp updated_at = 14 [(calixa.oltp.oltp_field) = {nullable: false}];
  google.protobuf.Timestamp deleted_at = 15 [(calixa.oltp.oltp_field) = {nullable: true}];
}

enum AudienceSyncLogState {
  AUDIENCE_SYNC_LOG_STATE_UNSPECIFIED = 0;
  AUDIENCE_SYNC_LOG_STATE_IN_PROGRESS = 1;
  AUDIENCE_SYNC_LOG_STATE_SUCCESS = 2;
  AUDIENCE_SYNC_LOG_STATE_FAILED = 3;
}

message LinkedInAdsSyncLogMetadata {
  int64 users_added_to_campaign_count = 1;
  int64 users_removed_from_campaign_count = 2;
}

message SalesforceSyncLogMetadata {
  int64 contacts_synced_count = 1;
}

message AudienceSyncLogMetadata {
  oneof metadata {
    LinkedInAdsSyncLogMetadata linked_in_ads_sync_log_metadata = 1;
    SalesforceSyncLogMetadata salesforce_sync_log_metadata = 2;
  }
}

message AudienceSyncLog {
  option (calixa.oltp.oltp_primary_key) = {field_ids: [1, 3]};

  string organization_id = 1;
  string audience_sync_id = 2;
  string audience_sync_log_id = 3;

  AudienceSyncLogState state = 4;
  AudienceSyncLogMetadata metadata = 5 [(calixa.oltp.oltp_field) = {nullable: true}];

  google.protobuf.Timestamp created_at = 6 [(calixa.oltp.oltp_field) = {nullable: false}];
  google.protobuf.Timestamp updated_at = 7 [(calixa.oltp.oltp_field) = {nullable: true}];
  google.protobuf.Timestamp completed_at = 8 [(calixa.oltp.oltp_field) = {nullable: true}];
}
