syntax = "proto3";

import "google/protobuf/timestamp.proto";
import "google/protobuf/struct.proto";
import "google/protobuf/field_mask.proto";
import "google/protobuf/empty.proto";

import "common.proto";
import "event_label.proto";
import "push_notification.proto";
import "condition.proto";
import "action.proto";
import "entity_reference.proto";

import "oltpannotation.proto";

option java_package = "io.calixa.domain.automation";
option java_multiple_files = true;
option optimize_for = SPEED;

package calixa.domain.automation;

enum AutomationStatus {
  AUTOMATION_STATUS_UNSPECIFIED = 0;
  AUTOMATION_STATUS_ENABLED = 1;
  AUTOMATION_STATUS_PAUSED = 2;
}

enum AutomationType {
  AUTOMATION_TYPE_UNSPECIFIED = 0;
  AUTOMATION_TYPE_AUTOMATION = 1;
  AUTOMATION_TYPE_ALERT = 2;
}

// suppression period for automation actions, used on suppression mechanisms
// there is a reasoning to this being here, not all automations will have
// frequency, so we must add to the specific ActionParams in order for the UI
// to be able to show the fields
enum AutomationActionSuppressionPeriod {
  AUTOMATION_SUPPRESSION_PERIOD_UNSPECIFIED = 0;
  AUTOMATION_SUPPRESSION_PERIOD_HOURLY = 1;
  AUTOMATION_SUPPRESSION_PERIOD_DAILY = 2;
  AUTOMATION_SUPPRESSION_PERIOD_WEEKLY = 3;
  AUTOMATION_SUPPRESSION_PERIOD_MONTHLY = 4;
  AUTOMATION_SUPPRESSION_PERIOD_QUARTERLY = 5;
  AUTOMATION_SUPPRESSION_PERIOD_YEARLY = 6;

  AUTOMATION_SUPPRESSION_PERIOD_ALL_TIME = 1000;
}

message EventTrigger {
  calixa.domain.entity.EventLabel event_label = 1;
  calixa.domain.condition.ConditionGroup trigger = 2;
}

message MetricTrigger {
  calixa.domain.condition.ConditionGroup trigger = 1;
}

message Trigger {
  oneof trigger {
    EventTrigger event_trigger = 100;
    MetricTrigger metric_trigger = 101;
  }
}

message AutomationActionConfig {
  calixa.domain.action.ActionParams action_params = 1;
  string action_id = 2;
}

message SendToInboxAction {
  entity.EntityReference entity_reference = 1;

  string playbook_id = 2;

  // this owner_id follow the same logic as Actions, if current_owner
  // then get it from Ownership, otherwise set the value specified by UI
  string owner_id = 3;
  // additional notification that will be send with this inbox
  calixa.domain.notification.Notification notification = 4;
  SendToInboxActionVersion version = 5;
}

enum SendToInboxActionVersion {
  SEND_TO_INBOX_ACTION_VERSION_UNSPECIFIED = 0;
  SEND_TO_INBOX_ACTION_VERSION_V1 = 1;
  SEND_TO_INBOX_ACTION_VERSION_V2 = 2;
}

message AutomationAction {
  oneof automationAction {
    calixa.domain.notification.Notification notification = 1;
    AutomationActionConfig action = 3; // represents Standard and Custom Actions
    SendToInboxAction send_to_inbox = 6;
  }
  reserved 2; // UpdateEntityAction update_entity = 2;
  reserved 5; // string task_owner = 5;

  AutomationActionSuppressionPeriod suppression_period = 4; // field used for automations

  string time_zone = 52;

  repeated AutomationProperty properties = 7;
}

message AutomationActionResult {
  oneof automationAction_Result {
    bool sent = 1;
    HttpResponses http_responses = 2;

    string error = 1000;
    bool suppressed = 1001;
    bool rate_limited = 1002;
  }
  string automation_run_id = 3;
}

// Responses related to an Entity (canonical ID) from AutomationAction invoked through automations
message HttpResponses {
  map<string, action.ThirdPartyActionInvocationResponse> http_response = 1;
}

message Automation {
  option (calixa.oltp.oltp_primary_key) = {field_ids: [10, 11]};

  // TODO (luis): Remove "^$|" from the following validation rules after updating the AutomationService.
  string organization_id = 10;
  string automation_id = 11;

  string title = 1 [(calixa.oltp.oltp_field) = {nullable: false}];
  AutomationStatus status = 2 [(calixa.oltp.oltp_field) = {nullable: false}];
  Trigger trigger = 3 [(calixa.oltp.oltp_field) = {nullable: true}];
  AutomationAction automation_action = 4 [(calixa.oltp.oltp_field) = {nullable: true}];
  common.EntityType entity_type = 5 [(calixa.oltp.oltp_field) = {nullable: false}];
  string created_by_organization_user_id = 6;
  AutomationType type = 7 [(calixa.oltp.oltp_field) = {nullable: false}];

  google.protobuf.Timestamp created_at = 12 [(calixa.oltp.oltp_field) = {nullable: false}];
  google.protobuf.Timestamp updated_at = 13 [(calixa.oltp.oltp_field) = {nullable: false}];
  google.protobuf.Timestamp deleted_at = 14 [(calixa.oltp.oltp_field) = {nullable: true}];
}

message AutomationProperty {
  oneof metric_range {
    MetricAutomationProperty metric_automation_property = 1;
    FieldMetricProperty field_metric_property = 2;
  }
}

message FieldMetricProperty {
  string field = 1; // this is the field value from conditions, eg: account.name, account_user.email
}

message MetricAutomationProperty {
  string metric_descriptor_id = 1;
  oneof metric_range {
    calixa.domain.condition.RelativeTimeRange relative_time_range = 2;
    calixa.domain.condition.AbsoluteTimeRange absolute_time_range = 3;
  }
}