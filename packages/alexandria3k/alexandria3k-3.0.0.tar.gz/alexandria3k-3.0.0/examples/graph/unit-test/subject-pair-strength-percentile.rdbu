BEGIN SETUP
work_subject_citations:
citing_subject_id	cited_subject_id	citations_number
1			2			6
2			1			2
1			3			8
END

BEGIN CREATE
CREATE TABLE subject_pair_fundamentalness_percentile AS
  WITH subject_pair_fundamentalness AS (
    SELECT
        cited.citing_subject_id, cited.cited_subject_id,
        Cast(cited.citations_number AS float)
          / (Coalesce(citing.citations_number, 0) + cited.citations_number)
            AS cited_fundamentalness
        FROM work_subject_citations AS cited
        LEFT JOIN work_subject_citations AS citing
          ON citing.citing_subject_id = cited.cited_subject_id AND
             citing.cited_subject_id = cited.citing_subject_id
    )
  SELECT *, NTILE(100) OVER(ORDER BY cited_fundamentalness ASC) AS percentile
  FROM subject_pair_fundamentalness;
END

BEGIN RESULT
subject_pair_fundamentalness_percentile:
citing_subject_id	cited_subject_id	cited_fundamentalness	percentile
1			2			0.75			2
2			1			0.25			1
1			3			1.0			3
END
